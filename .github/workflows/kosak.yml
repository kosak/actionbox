name: kosak-build
run-name: first stab at builtin caching
on: [push, workflow_dispatch]

env:
  USERNAME: kosak
  VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
  FEED_URL: https://nuget.pkg.github.com/kosak/index.json
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/kosak/index.json,readwrite"

jobs:
  job:
    name: Build prog1
    runs-on: windows-2025

    steps:
      # echo sad
      - run: echo ${{ github.workspace }}
      - run: echo ${{ runner.workspace }}

      # Check out my repo
      - uses: actions/checkout@v5

      # Check out vcpkg
      - uses: actions/checkout@v5
        with:
          repository: microsoft/vcpkg
          path: vcpkg

      - name: Bootstrap vcpkg
        shell: cmd
        run: ./vcpkg/bootstrap-vcpkg.bat

      - name: Operation sad
        run: dir ${{ env.VCPKG_EXE }}
        
      - name: Add Github NuGet sources
        shell: pwsh
        run: |
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
          sources add `
          -Source "${{ env.FEED_URL }}" `
          -StorePasswordInClearText `
          -Name GitHubPackages `
          -UserName "${{ env.USERNAME }}" `
          -Password "${{ secrets.GH_PACKAGES_TOKEN }}"
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
          setapikey "${{ secrets.GH_PACKAGES_TOKEN }}" `
          -Source "${{ env.FEED_URL }}"
        
      - name: Configure vcpkg for GitHub Actions Cache
        shell: bash
        run: |
          echo "VCPKG_BINARY_SOURCES=clear;github" >> $GITHUB_ENV

      - name: Run cmake configuration
        shell: cmd
        run: cmake -S cpp/prog1 -B cpp/prog1/build --toolchain ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

      # Run cmake build
      - shell: cmd
        run: cmake --build cpp/prog1/build --config RelWithDebInfo
